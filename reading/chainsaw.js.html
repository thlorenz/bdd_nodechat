<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>~/Dropboxes/Gmail/Dropbox/dev/javascript/node/sourcetopdf/node_modules/seq/node_modules/chainsaw/index.js.html</title>
<meta name="Generator" content="Vim/7.3">
<meta name="plugin-version" content="vim7.3_v6">
<meta name="syntax" content="javascript">
<meta name="settings" content="use_css,number_lines">
<style type="text/css">
<!--
pre { font-family: monospace; color: #ffffff; background-color: #333333; }
body { font-family: monospace; color: #ffffff; background-color: #333333; }
.lnr { color: #ffff00; }
.Comment { color: #87ceeb; }
.Type { color: #bdb76b; font-weight: bold; }
.Statement { color: #f0e68c; font-weight: bold; }
.Constant { color: #ffa0a0; }
.Identifier { color: #98fb98; }
-->
</style>
</head>
<body>
<pre>
<span class="lnr">  1 </span><span class="Identifier">var</span> Traverse = require(<span class="Constant">'traverse'</span>);
<span class="lnr">  2 </span><span class="Identifier">var</span> EventEmitter = require(<span class="Constant">'events'</span>).EventEmitter;
<span class="lnr">  3 </span>
<span class="lnr">  4 </span>module.exports = Chainsaw;
<span class="lnr">  5 </span><span class="Identifier">function</span> Chainsaw (builder) <span class="Identifier">{</span>
<span class="lnr">  6 </span>    <span class="Identifier">var</span> saw = Chainsaw.saw(builder, <span class="Identifier">{}</span>);
<span class="lnr">  7 </span>    <span class="Identifier">var</span> r = builder.call(saw.handlers, saw);
<span class="lnr">  8 </span>    <span class="Statement">if</span> (r !== <span class="Statement">undefined</span>) saw.handlers = r;
<span class="lnr">  9 </span>    <span class="Statement">return</span> saw.chain();
<span class="lnr"> 10 </span><span class="Identifier">}</span>;
<span class="lnr"> 11 </span>
<span class="lnr"> 12 </span>Chainsaw.saw = <span class="Identifier">function</span> (builder, handlers) <span class="Identifier">{</span>
<span class="lnr"> 13 </span>    <span class="Identifier">var</span> saw = <span class="Statement">new</span> EventEmitter;
<span class="lnr"> 14 </span>    saw.handlers = handlers;
<span class="lnr"> 15 </span>    saw.actions = <span class="Identifier">[]</span>;
<span class="lnr"> 16 </span>    saw.step = 0;
<span class="lnr"> 17 </span>
<span class="lnr"> 18 </span>    saw.chain = <span class="Identifier">function</span> () <span class="Identifier">{</span>
<span class="lnr"> 19 </span>        <span class="Identifier">var</span> ch = Traverse(saw.handlers).map(<span class="Identifier">function</span> (node) <span class="Identifier">{</span>
<span class="lnr"> 20 </span>            <span class="Statement">if</span> (<span class="Identifier">this</span>.isRoot) <span class="Statement">return</span> node;
<span class="lnr"> 21 </span>            <span class="Identifier">var</span> ps = <span class="Identifier">this</span>.path;
<span class="lnr"> 22 </span>
<span class="lnr"> 23 </span>            <span class="Statement">if</span> (<span class="Statement">typeof</span> node === <span class="Constant">'function'</span>) <span class="Identifier">{</span>
<span class="lnr"> 24 </span>                <span class="Identifier">this</span>.update(<span class="Identifier">function</span> () <span class="Identifier">{</span>
<span class="lnr"> 25 </span>                    saw.actions.push(<span class="Identifier">{</span>
<span class="lnr"> 26 </span>                        path : ps,
<span class="lnr"> 27 </span>                        args : <span class="Identifier">[]</span>.slice.call(<span class="Identifier">arguments</span>)
<span class="lnr"> 28 </span>                    <span class="Identifier">}</span>);
<span class="lnr"> 29 </span>                    <span class="Statement">return</span> ch;
<span class="lnr"> 30 </span>                <span class="Identifier">}</span>);
<span class="lnr"> 31 </span>            <span class="Identifier">}</span>
<span class="lnr"> 32 </span>        <span class="Identifier">}</span>);
<span class="lnr"> 33 </span>
<span class="lnr"> 34 </span>        process.nextTick(<span class="Identifier">function</span> () <span class="Identifier">{</span>
<span class="lnr"> 35 </span>            saw.emit(<span class="Constant">'begin'</span>);
<span class="lnr"> 36 </span>            saw.next();
<span class="lnr"> 37 </span>        <span class="Identifier">}</span>);
<span class="lnr"> 38 </span>
<span class="lnr"> 39 </span>        <span class="Statement">return</span> ch;
<span class="lnr"> 40 </span>    <span class="Identifier">}</span>;
<span class="lnr"> 41 </span>
<span class="lnr"> 42 </span>    saw.next = <span class="Identifier">function</span> () <span class="Identifier">{</span>
<span class="lnr"> 43 </span>        <span class="Identifier">var</span> action = saw.actions<span class="Identifier">[</span>saw.step<span class="Identifier">]</span>;
<span class="lnr"> 44 </span>        saw.step ++;
<span class="lnr"> 45 </span>
<span class="lnr"> 46 </span>        <span class="Statement">if</span> (!action) <span class="Identifier">{</span>
<span class="lnr"> 47 </span>            saw.emit(<span class="Constant">'end'</span>);
<span class="lnr"> 48 </span>        <span class="Identifier">}</span>
<span class="lnr"> 49 </span>        <span class="Statement">else</span> <span class="Statement">if</span> (!action.trap) <span class="Identifier">{</span>
<span class="lnr"> 50 </span>            <span class="Identifier">var</span> node = saw.handlers;
<span class="lnr"> 51 </span>            action.path.forEach(<span class="Identifier">function</span> (key) <span class="Identifier">{</span> node = node<span class="Identifier">[</span>key<span class="Identifier">]</span> <span class="Identifier">}</span>);
<span class="lnr"> 52 </span>            node.apply(saw.handlers, action.args);
<span class="lnr"> 53 </span>        <span class="Identifier">}</span>
<span class="lnr"> 54 </span>    <span class="Identifier">}</span>;
<span class="lnr"> 55 </span>
<span class="lnr"> 56 </span>    saw.nest = <span class="Identifier">function</span> (cb) <span class="Identifier">{</span>
<span class="lnr"> 57 </span>        <span class="Identifier">var</span> args = <span class="Identifier">[]</span>.slice.call(<span class="Identifier">arguments</span>, 1);
<span class="lnr"> 58 </span>        <span class="Identifier">var</span> autonext = <span class="Constant">true</span>;
<span class="lnr"> 59 </span>
<span class="lnr"> 60 </span>        <span class="Statement">if</span> (<span class="Statement">typeof</span> cb === <span class="Constant">'boolean'</span>) <span class="Identifier">{</span>
<span class="lnr"> 61 </span>            <span class="Identifier">var</span> autonext = cb;
<span class="lnr"> 62 </span>            cb = args.shift();
<span class="lnr"> 63 </span>        <span class="Identifier">}</span>
<span class="lnr"> 64 </span>
<span class="lnr"> 65 </span>        <span class="Identifier">var</span> s = Chainsaw.saw(builder, <span class="Identifier">{}</span>);
<span class="lnr"> 66 </span>        <span class="Identifier">var</span> r = builder.call(s.handlers, s);
<span class="lnr"> 67 </span>
<span class="lnr"> 68 </span>        <span class="Statement">if</span> (r !== <span class="Statement">undefined</span>) s.handlers = r;
<span class="lnr"> 69 </span>        cb.apply(s.chain(), args);
<span class="lnr"> 70 </span>        <span class="Statement">if</span> (autonext !== <span class="Constant">false</span>) s.on(<span class="Constant">'end'</span>, saw.next);
<span class="lnr"> 71 </span>    <span class="Identifier">}</span>;
<span class="lnr"> 72 </span>
<span class="lnr"> 73 </span>    saw.trap = <span class="Identifier">function</span> (name, cb) <span class="Identifier">{</span>
<span class="lnr"> 74 </span>        <span class="Identifier">var</span> ps = <span class="Type">Array</span>.isArray(name) ? name : <span class="Identifier">[</span>name<span class="Identifier">]</span>;
<span class="lnr"> 75 </span>        saw.actions.push(<span class="Identifier">{</span>
<span class="lnr"> 76 </span>            path : ps,
<span class="lnr"> 77 </span>            step : saw.step,
<span class="lnr"> 78 </span>            cb : cb,
<span class="lnr"> 79 </span>            trap : <span class="Constant">true</span>
<span class="lnr"> 80 </span>        <span class="Identifier">}</span>);
<span class="lnr"> 81 </span>    <span class="Identifier">}</span>;
<span class="lnr"> 82 </span>
<span class="lnr"> 83 </span>    saw.down = <span class="Identifier">function</span> (name) <span class="Identifier">{</span>
<span class="lnr"> 84 </span>        <span class="Identifier">var</span> ps = (<span class="Type">Array</span>.isArray(name) ? name : <span class="Identifier">[</span>name<span class="Identifier">]</span>).join(<span class="Constant">'/'</span>);
<span class="lnr"> 85 </span>        <span class="Identifier">var</span> i = saw.actions.slice(saw.step).map(<span class="Identifier">function</span> (x) <span class="Identifier">{</span>
<span class="lnr"> 86 </span>            <span class="Statement">if</span> (x.trap &amp;&amp; x.step &lt;= saw.step) <span class="Statement">return</span> <span class="Constant">false</span>;
<span class="lnr"> 87 </span>            <span class="Statement">return</span> x.path.join(<span class="Constant">'/'</span>) == ps;
<span class="lnr"> 88 </span>        <span class="Identifier">}</span>).indexOf(<span class="Constant">true</span>);
<span class="lnr"> 89 </span>
<span class="lnr"> 90 </span>        <span class="Statement">if</span> (i &gt;= 0) saw.step += i;
<span class="lnr"> 91 </span>        <span class="Statement">else</span> saw.step = saw.actions.length;
<span class="lnr"> 92 </span>
<span class="lnr"> 93 </span>        <span class="Identifier">var</span> act = saw.actions<span class="Identifier">[</span>saw.step - 1<span class="Identifier">]</span>;
<span class="lnr"> 94 </span>        <span class="Statement">if</span> (act &amp;&amp; act.trap) <span class="Identifier">{</span>
<span class="lnr"> 95 </span>            <span class="Comment">// It's a trap!</span>
<span class="lnr"> 96 </span>            saw.step = act.step;
<span class="lnr"> 97 </span>            act.cb();
<span class="lnr"> 98 </span>        <span class="Identifier">}</span>
<span class="lnr"> 99 </span>        <span class="Statement">else</span> saw.next();
<span class="lnr">100 </span>    <span class="Identifier">}</span>;
<span class="lnr">101 </span>
<span class="lnr">102 </span>    saw.jump = <span class="Identifier">function</span> (step) <span class="Identifier">{</span>
<span class="lnr">103 </span>        saw.step = step;
<span class="lnr">104 </span>        saw.next();
<span class="lnr">105 </span>    <span class="Identifier">}</span>;
<span class="lnr">106 </span>
<span class="lnr">107 </span>    <span class="Statement">return</span> saw;
<span class="lnr">108 </span><span class="Identifier">}</span>;
</pre>
</body>
</html>
